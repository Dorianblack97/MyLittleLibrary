@page "/manage-films"
@using MyLittleLibrary.Domain

<PageTitle>Manage Films</PageTitle>
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudPaper Elevation="3" Class="pa-4 mb-4">
        <MudText Typo="Typo.h4" Class="mb-4">Manage Film Collection</MudText>
        
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="searchQuery" Label="Search by title or director" Immediate="true" 
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Search"
                              OnAdornmentClick="SearchFilms" OnKeyDown="@OnSearchKeyDown"/>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
    <MudSelect T="int" @bind-Value="selectedFormatValue" Label="Filter by format" 
               Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter"
               OnValueChanged="@FormatFilterChanged">
        <MudSelectItem Value="-1">All Formats</MudSelectItem>
        @foreach (var format in Enum.GetValues<VideoFormat>())
        {
            <MudSelectItem Value="@((int)format)">@format</MudSelectItem>
        }
    </MudSelect>
</MudItem>
            <MudItem xs="12" sm="6" md="4" Class="d-flex justify-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="@(() => OpenAddFilmDialog())"
                           Class="mr-2">
                    Add Film
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.DeleteSweep"
                           OnClick="@(() => OpenDeleteAllFilmsDialog())"
                           Disabled="@(!filteredFilms.Any())">
                    Delete All
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (isLoading)
    {
        <div class="d-flex justify-center">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
        </div>
    }
    else if (!filteredFilms.Any())
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">No films found. Try a different search term or add new films.</MudAlert>
    }
    else
    {
        <MudTable Items="@filteredFilms" Hover="true" Breakpoint="Breakpoint.Sm" T="Video.Film" 
                  Loading="@isLoading" LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Title</MudTh>
                <MudTh>Director</MudTh>
                <MudTh>Format</MudTh>
                <MudTh>Release Date</MudTh>
                <MudTh>Watch Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Title">
                    <div class="d-flex align-center">
                        @if (!string.IsNullOrEmpty(context.ImagePath))
                        {
                            <MudAvatar Class="mr-2" Style="width: 40px; height: 60px; border-radius: 4px;">
                                <MudImage Src="@context.ImagePath" />
                            </MudAvatar>
                        }
                        else
                        {
                            <MudAvatar Color="Color.Secondary" Class="mr-2" Style="width: 40px; height: 60px; border-radius: 4px;">
                                <MudIcon Icon="@Icons.Material.Filled.Movie" />
                            </MudAvatar>
                        }
                        <MudText>@context.Title</MudText>
                    </div>
                </MudTd>
                <MudTd DataLabel="Director">@context.Director</MudTd>
                <MudTd DataLabel="Format">
                    <MudChip T="string" Color="@GetFormatColor(context.Format)" Size="Size.Small">
                        @context.Format
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Release Date">@(context.ReleaseDate?.ToShortDateString() ?? "-")</MudTd>
                <MudTd DataLabel="Watch Status">
                    <MudChip T="string" Color="@(context.IsWatched ? Color.Success : Color.Warning)" Size="Size.Small"
                             Icon="@(context.IsWatched ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Schedule)">
                        @(context.IsWatched ? "Watched" : "Not Watched")
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Primary" 
                                   OnClick="@(() => ViewFilmDetails(context.Title))" 
                                   Title="View Details"/>
                    <MudIconButton Icon="@(context.IsWatched ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)" 
                                   Color="Color.Secondary" 
                                   OnClick="@(() => ToggleWatchedStatus(context))" 
                                   Title="@(context.IsWatched ? "Mark as Unwatched" : "Mark as Watched")"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" 
                                   OnClick="@(() => OpenEditFilmDialog(context))" 
                                   Title="Edit Film"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                   OnClick="@(() => OpenDeleteFilmDialog(context))" 
                                   Title="Delete Film"/>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
</MudContainer>
